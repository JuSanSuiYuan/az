#!/usr/bin/env python3
"""
az cl Compiler Driver
å®Œæ•´çš„az clç¼–è¯‘å™¨é©±åŠ¨ç¨‹åº
"""

import sys
import os
import subprocess
import argparse
import tempfile
from pathlib import Path

class AZCompilerDriver:
    """AZç¼–è¯‘å™¨é©±åŠ¨ç¨‹åº"""
    
    def __init__(self):
        self.project_root = Path(__file__).parent.parent
        self.bootstrap_dir = self.project_root / "bootstrap"
        self.compiler_dir = self.project_root / "compiler"
        self.runtime_dir = self.project_root / "runtime"
        self.lib_dir = self.project_root / "lib"
        
    def compile(self, source_files, output_file=None, options=None):
        """ç¼–è¯‘AZæºæ–‡ä»¶"""
        if options is None:
            options = {}
            
        print(f"ğŸ”¨ ç¼–è¯‘AZç¨‹åº...")
        
        # 1. ä½¿ç”¨C++ç¼–è¯‘å™¨ç¼–è¯‘æºæ–‡ä»¶
        print("[1/4] ä½¿ç”¨C++åç«¯ç¼–è¯‘...")
        llvm_ir = self.compile_with_cpp_backend(source_files, options)
        if llvm_ir is None:
            print("âŒ C++ç¼–è¯‘å¤±è´¥")
            return False
        
        # 2. ä½¿ç”¨LLVMåç«¯å¤„ç†
        print("[2/4] ä½¿ç”¨LLVMåç«¯å¤„ç†...")
        if not self.process_with_llvm_backend(llvm_ir, output_file or "a.out", options):
            print("âŒ LLVMåç«¯å¤„ç†å¤±è´¥")
            return False
        
        # 3. é“¾æ¥
        print("[3/4] é“¾æ¥...")
        if not self.link(output_file or "a.out", options):
            print("âŒ é“¾æ¥å¤±è´¥")
            return False
        
        # 4. å®Œæˆ
        print("[4/4] å®Œæˆ!")
        print(f"âœ… ç¼–è¯‘æˆåŠŸ: {output_file or 'a.out'}")
        return True
    
    def compile_with_cpp_backend(self, source_files, options):
        """ä½¿ç”¨C++åç«¯ç¼–è¯‘"""
        try:
            # æ„å»ºC++ç¼–è¯‘å™¨è·¯å¾„
            cpp_compiler = self.project_root / "build" / "az_compiler"
            if not cpp_compiler.exists():
                print("âŒ C++ç¼–è¯‘å™¨æœªæ‰¾åˆ°ã€‚è¯·å…ˆæ„å»ºå®ƒã€‚")
                print("è¿è¡Œ: cd build && cmake .. && make")
                return None
            
            # åˆ›å»ºä¸´æ—¶ç›®å½•å­˜å‚¨ä¸­é—´æ–‡ä»¶
            with tempfile.TemporaryDirectory() as temp_dir:
                temp_path = Path(temp_dir)
                ir_file = temp_path / "output.ll"
                
                # æ„å»ºå‘½ä»¤
                cmd = [str(cpp_compiler)]
                
                # æ·»åŠ é€‰é¡¹
                if options.get('verbose'):
                    cmd.append('-v')
                
                if options.get('debug'):
                    cmd.append('-g')
                
                # AOTç¼–è¯‘é€‰é¡¹
                if options.get('aot'):
                    cmd.append('--aot')
                
                # é“¾æ¥å™¨é€‰é¡¹
                if options.get('linker'):
                    cmd.extend(['--linker', options.get('linker')])
                
                # è¾“å‡ºç±»å‹
                cmd.extend(['-emit-llvm', '-o', str(ir_file)])
                
                # æ·»åŠ æºæ–‡ä»¶
                cmd.extend(source_files)
                
                print(f"æ‰§è¡Œå‘½ä»¤: {' '.join(cmd)}")
                
                # æ‰§è¡Œç¼–è¯‘
                result = subprocess.run(
                    cmd,
                    capture_output=True,
                    text=True
                )
                
                if result.returncode != 0:
                    print("C++ç¼–è¯‘å™¨è¾“å‡º:")
                    if result.stdout:
                        print(result.stdout)
                    if result.stderr:
                        print(result.stderr, file=sys.stderr)
                    return None
                
                # è¯»å–ç”Ÿæˆçš„LLVM IR
                if ir_file.exists():
                    with open(ir_file, 'r') as f:
                        return f.read()
                else:
                    print("âŒ LLVM IRæ–‡ä»¶æœªç”Ÿæˆ")
                    return None
                    
        except Exception as e:
            print(f"C++ç¼–è¯‘é”™è¯¯: {e}")
            return None
    
    def process_with_llvm_backend(self, llvm_ir, output_file, options):
        """ä½¿ç”¨LLVMåç«¯å¤„ç†"""
        try:
            # åˆ›å»ºä¸´æ—¶ç›®å½•å­˜å‚¨ä¸­é—´æ–‡ä»¶
            with tempfile.TemporaryDirectory() as temp_dir:
                temp_path = Path(temp_dir)
                ir_file = temp_path / "input.ll"
                obj_file = temp_path / "output.o"
                
                # å†™å…¥LLVM IR
                with open(ir_file, 'w') as f:
                    f.write(llvm_ir)
                
                # ä½¿ç”¨lliæˆ–llcå¤„ç†LLVM IR
                opt_level = options.get('opt_level', 'O2')
                
                # ä¼˜åŒ–
                opt_cmd = ['opt', f'-{opt_level}', str(ir_file), '-o', str(obj_file)]
                print(f"æ‰§è¡Œä¼˜åŒ–å‘½ä»¤: {' '.join(opt_cmd)}")
                result = subprocess.run(opt_cmd, capture_output=True, text=True)
                
                if result.returncode != 0:
                    print("LLVM optè¾“å‡º:")
                    if result.stdout:
                        print(result.stdout)
                    if result.stderr:
                        print(result.stderr, file=sys.stderr)
                    return False
                
                # å¤åˆ¶å¯¹è±¡æ–‡ä»¶åˆ°è¾“å‡ºä½ç½®
                import shutil
                shutil.copy2(obj_file, output_file + ".o")
                
                return True
                    
        except Exception as e:
            print(f"LLVMåç«¯é”™è¯¯: {e}")
            return False
    
    def link(self, output_file, options):
        """é“¾æ¥å¯¹è±¡æ–‡ä»¶"""
        try:
            obj_file = output_file + ".o"
            
            # æ£€æµ‹é“¾æ¥å™¨
            linker_type = options.get('linker', 'auto')
            if linker_type == 'auto':
                linker = self.detect_linker()
            else:
                linker = linker_type
            
            if not linker:
                print("âŒ æœªæ‰¾åˆ°é“¾æ¥å™¨ (lld, mold, gcc, clang, æˆ– cl)")
                return False
            
            # æ„å»ºé“¾æ¥å‘½ä»¤
            if linker == "cl":  # MSVC
                cmd = [
                    linker,
                    "/nologo",
                    obj_file,
                    f"/Fe{output_file}",
                    "/link", "/SUBSYSTEM:CONSOLE"
                ]
            else:  # lld, mold, gcc, clang
                cmd = [
                    linker,
                    obj_file,
                    "-o", output_file
                ]
            
            # æ·»åŠ é“¾æ¥é€‰é¡¹
            if options.get('static_link'):
                cmd.append('-static')
            
            if options.get('lto'):
                cmd.append('-flto')
            
            if options.get('pie'):
                cmd.append('-pie')
            
            if options.get('strip'):
                cmd.append('-strip-all')
            
            print(f"æ‰§è¡Œé“¾æ¥å‘½ä»¤: {' '.join(cmd)}")
            
            # æ‰§è¡Œé“¾æ¥
            result = subprocess.run(cmd, capture_output=True, text=True)
            
            if result.returncode != 0:
                print("é“¾æ¥å™¨è¾“å‡º:")
                if result.stdout:
                    print(result.stdout)
                if result.stderr:
                    print(result.stderr, file=sys.stderr)
                return False
            
            # æ¸…ç†ä¸´æ—¶å¯¹è±¡æ–‡ä»¶
            if os.path.exists(obj_file):
                os.remove(obj_file)
            
            return True
            
        except Exception as e:
            print(f"é“¾æ¥é”™è¯¯: {e}")
            return False
    
    def detect_linker(self):
        """æ£€æµ‹å¯ç”¨çš„é“¾æ¥å™¨"""
        # ä¼˜å…ˆæ£€æµ‹mold
        linkers = ["mold", "lld", "gcc", "clang", "cl"]
        
        for linker in linkers:
            try:
                result = subprocess.run(
                    [linker, "--version"],
                    capture_output=True,
                    text=True,
                    timeout=5
                )
                if result.returncode == 0:
                    return linker
            except (FileNotFoundError, subprocess.TimeoutExpired):
                continue
        
        return None
    
    def run_jit(self, source_files, args=None, options=None):
        """JITè¿è¡ŒAZç¨‹åº"""
        if options is None:
            options = {}
            
        print(f"ğŸƒ ä½¿ç”¨JITè¿è¡ŒAZç¨‹åº...")
        
        try:
            # ä½¿ç”¨C++ç¼–è¯‘å™¨JITè¿è¡Œ
            cpp_compiler = self.project_root / "build" / "az_compiler"
            if not cpp_compiler.exists():
                print("âŒ C++ç¼–è¯‘å™¨æœªæ‰¾åˆ°ã€‚è¯·å…ˆæ„å»ºå®ƒã€‚")
                return False
            
            # æ„å»ºå‘½ä»¤
            cmd = [str(cpp_compiler), '--jit']
            
            # æ·»åŠ é€‰é¡¹
            if options.get('verbose'):
                cmd.append('-v')
            
            if options.get('debug'):
                cmd.append('-g')
            
            # æ·»åŠ æºæ–‡ä»¶
            cmd.extend(source_files)
            
            # æ·»åŠ ç¨‹åºå‚æ•°
            if args:
                cmd.append('--')
                cmd.extend(args)
            
            print(f"æ‰§è¡ŒJITå‘½ä»¤: {' '.join(cmd)}")
            
            # æ‰§è¡ŒJITè¿è¡Œ
            result = subprocess.run(cmd)
            
            return result.returncode == 0
                    
        except Exception as e:
            print(f"JITæ‰§è¡Œé”™è¯¯: {e}")
            return False

    def clean_cache(self, cache_dir=".az_cache"):
        """æ¸…ç†ç¼–è¯‘ç¼“å­˜"""
        cache_path = Path(cache_dir)
        if cache_path.exists():
            import shutil
            try:
                shutil.rmtree(cache_path)
                print(f"âœ… æ¸…ç†ç¼“å­˜å®Œæˆ: {cache_dir}")
                return True
            except Exception as e:
                print(f"âŒ æ¸…ç†ç¼“å­˜å¤±è´¥: {e}")
                return False
        else:
            print(f"â„¹ï¸  ç¼“å­˜ç›®å½•ä¸å­˜åœ¨: {cache_dir}")
            return True

    def show_version(self):
        """æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯"""
        print("az cl Compiler Driver v0.4.0")
        print("Copyright (c) 2025 AZ Language Project")
        print("åŸºäºLLVMå’ŒMLIRæŠ€æœ¯æ ˆ")

def main():
    """ä¸»å‡½æ•°"""
    parser = argparse.ArgumentParser(
        description="az clç¼–è¯‘å™¨é©±åŠ¨ç¨‹åº - ç¼–è¯‘å’Œè¿è¡ŒAZç¨‹åº",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹:
  az_cl hello.az                    # ç¼–è¯‘hello.azåˆ°a.out
  az_cl hello.az -o hello           # ç¼–è¯‘hello.azåˆ°hello
  az_cl --jit hello.az              # ä½¿ç”¨JITè¿è¡Œhello.az
  az_cl --aot hello.az              # ä½¿ç”¨AOTç¼–è¯‘hello.az
  az_cl --emit-llvm hello.az        # è¾“å‡ºLLVM IR
  az_cl --emit-asm hello.az         # è¾“å‡ºæ±‡ç¼–ä»£ç 
        """
    )
    
    parser.add_argument('sources', nargs='*', help='æºæ–‡ä»¶ (.az)')
    parser.add_argument('-o', '--output', help='è¾“å‡ºæ–‡ä»¶å')
    parser.add_argument('-c', '--compile-only', action='store_true', 
                       help='ä»…ç¼–è¯‘ï¼Œä¸é“¾æ¥')
    parser.add_argument('-g', '--debug', action='store_true', 
                       help='ç”Ÿæˆè°ƒè¯•ä¿¡æ¯')
    parser.add_argument('-O', '--optimize', choices=['0', '1', '2', '3', 's', 'z'],
                       help='ä¼˜åŒ–çº§åˆ«')
    parser.add_argument('-v', '--verbose', action='store_true', 
                       help='è¯¦ç»†è¾“å‡º')
    parser.add_argument('--jit', action='store_true', 
                       help='ä½¿ç”¨JITç¼–è¯‘å™¨è¿è¡Œ')
    parser.add_argument('--aot', action='store_true', 
                       help='ä½¿ç”¨AOTç¼–è¯‘')
    parser.add_argument('--emit-llvm', action='store_true', 
                       help='è¾“å‡ºLLVM IR')
    parser.add_argument('--emit-asm', action='store_true', 
                       help='è¾“å‡ºæ±‡ç¼–ä»£ç ')
    parser.add_argument('--target', help='ç›®æ ‡ä¸‰å…ƒç»„')
    parser.add_argument('--static', action='store_true', 
                       help='é™æ€é“¾æ¥')
    parser.add_argument('--lto', action='store_true', 
                       help='å¯ç”¨LTO')
    parser.add_argument('--pie', action='store_true', 
                       help='ç”ŸæˆPIE')
    parser.add_argument('--strip', action='store_true', 
                       help='å»é™¤ç¬¦å·è¡¨')
    parser.add_argument('--linker', choices=['auto', 'lld', 'mold', 'gcc', 'clang', 'msvc'],
                       default='auto', help='æŒ‡å®šé“¾æ¥å™¨ç±»å‹')
    parser.add_argument('--clean-cache', action='store_true',
                       help='æ¸…ç†ç¼–è¯‘ç¼“å­˜')
    parser.add_argument('--version', action='store_true',
                       help='æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯')
    
    args = parser.parse_args()
    
    # æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
    if args.version:
        driver = AZCompilerDriver()
        driver.show_version()
        return 0
    
    # æ¸…ç†ç¼“å­˜
    if args.clean_cache:
        driver = AZCompilerDriver()
        return 0 if driver.clean_cache() else 1
    
    # æ£€æŸ¥æºæ–‡ä»¶
    if not args.sources:
        print("âŒ æœªæŒ‡å®šæºæ–‡ä»¶")
    parser.print_help()
    return 1
    
    for source in args.sources:
        if not os.path.exists(source):
            print(f"âŒ æºæ–‡ä»¶ä¸å­˜åœ¨: {source}")
            return 1
    
    # æ„å»ºé€‰é¡¹
    options = {
        'verbose': args.verbose,
        'debug': args.debug,
        'opt_level': f'O{args.optimize}' if args.optimize else 'O2',
        'target': args.target,
        'static_link': args.static,
        'lto': args.lto,
        'pie': args.pie,
        'strip': args.strip,
        'emit_llvm': args.emit_llvm,
        'emit_asm': args.emit_asm,
        'aot': args.aot,
        'linker': args.linker
    }
    
    # åˆ›å»ºç¼–è¯‘å™¨é©±åŠ¨
    driver = AZCompilerDriver()
    
    # JITè¿è¡Œ
    if args.jit:
        success = driver.run_jit(args.sources, sys.argv[sys.argv.index('--')+1:] 
                                if '--' in sys.argv else [], options)
        return 0 if success else 1
    
    # ç¼–è¯‘
    success = driver.compile(args.sources, args.output, options)
    return 0 if success else 1


if __name__ == '__main__':
    sys.exit(main())